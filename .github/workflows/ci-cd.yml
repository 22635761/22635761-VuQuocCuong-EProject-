name: CI/CD Pipeline with Docker

on:
  push:
    branches: [ main ]

jobs:
  verify-and-build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Setup Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '18'
          
      - name: Verify Services Installation
        run: |
          echo "ðŸ”§ Verifying services can be installed..."
          cd auth && npm install && echo "âœ… Auth: OK"
          cd ../product && npm install && echo "âœ… Product: OK"
          cd ../order && npm install && echo "âœ… Order: OK"
          cd ../api-gateway && npm install && echo "âœ… API Gateway: OK"

      - name: Create Dockerfiles
        run: |
          echo "ðŸ“ Creating Dockerfiles for all services..."
          
          # Táº¡o Dockerfile cho auth
          cat > auth/Dockerfile << EOF
          FROM node:18
          WORKDIR /app
          COPY package*.json ./
          RUN npm install
          COPY . .
          EXPOSE 3000
          CMD ["npm", "start"]
          EOF
          
          # Táº¡o Dockerfile cho product
          cat > product/Dockerfile << EOF
          FROM node:18
          WORKDIR /app
          COPY package*.json ./
          RUN npm install
          COPY . .
          EXPOSE 3001
          CMD ["npm", "start"]
          EOF
          
          # Táº¡o Dockerfile cho order
          cat > order/Dockerfile << EOF
          FROM node:18
          WORKDIR /app
          COPY package*.json ./
          RUN npm install
          COPY . .
          EXPOSE 3002
          CMD ["npm", "start"]
          EOF
          
          # Táº¡o Dockerfile cho api-gateway
          cat > api-gateway/Dockerfile << EOF
          FROM node:18
          WORKDIR /app
          COPY package*.json ./
          RUN npm install
          COPY . .
          EXPOSE 3003
          CMD ["npm", "start"]
          EOF
          
          echo "âœ… Dockerfiles created successfully!"

      - name: Build Docker Images
        run: |
          echo "ðŸ³ Building Docker images for all services..."
          docker build -t auth-service ./auth
          docker build -t product-service ./product
          docker build -t order-service ./order
          docker build -t api-gateway ./api-gateway
          echo "âœ… All Docker images built successfully!"
          
      - name: Verify Docker Images
        run: |
          echo "ðŸ“‹ Docker images built:"
          docker images | grep -E "(auth-service|product-service|order-service|api-gateway)"
          echo "ðŸŽ‰ CI/CD with Docker completed successfully!"